require("dotenv").config();
const express = require("express");
const mongoose = require("mongoose");
const cors = require("cors");
const multer = require("multer");
const path = require("path");
const fs = require("fs");

const app = express();
app.use(express.json());
app.use(cors());

// âœ… Ð“Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€ÑƒÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð»Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑŽÑ‚ÑÑ Ð² `backend/uploads/`
const uploadDir = path.join(__dirname, "uploads");
if (!fs.existsSync(uploadDir)) {
    fs.mkdirSync(uploadDir, { recursive: true });
}

// âœ… Ð Ð°Ð·Ð´Ð°Ñ‡Ð° Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð² (Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ!)
app.use("/uploads", express.static(uploadDir));

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº MongoDB
const MONGO_URI = process.env.MONGO_URI || "mongodb://localhost:27017/site-builder";
mongoose
    .connect(MONGO_URI)
    .then(() => console.log("âœ… MongoDB Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°"))
    .catch((err) => console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº MongoDB:", err.message));

// âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Multer Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼ Ð¿ÑƒÑ‚ÐµÐ¼
const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        cb(null, uploadDir);
    },
    filename: (req, file, cb) => {
        cb(null, Date.now() + path.extname(file.originalname));
    }
});

const fileFilter = (req, file, cb) => {
    const allowedTypes = ["image/png", "image/jpeg", "image/jpg", "image/webp"];
    if (allowedTypes.includes(file.mimetype)) {
        cb(null, true);
    } else {
        cb(new Error("ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ñ„Ð°Ð¹Ð»Ð°"), false);
    }
};

const upload = multer({ storage, fileFilter, limits: { fileSize: 100 * 1024 * 1024 } }); // Ð›Ð¸Ð¼Ð¸Ñ‚: 10MB
const DraftSettings = require("./models/draftSettings");
const LiveSettings = require("./models/liveSettings");

// âœ… Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÑÑ‚Ð°Ñ€Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð°
const deleteOldFile = (fileUrl) => {
    if (!fileUrl || !fileUrl.includes("/uploads/")) return;
    const filePath = path.join(__dirname, fileUrl.split("/uploads/")[1]);

    if (fs.existsSync(filePath)) {
        fs.unlink(filePath, (err) => {
            if (err) console.error("ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÑÑ‚Ð°Ñ€Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð°:", err);
            else console.log("ðŸ—‘ Ð¡Ñ‚Ð°Ñ€Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» ÑƒÐ´Ð°Ð»ÐµÐ½:", filePath);
        });
    }
};

// âœ… ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð¾Ð²
app.post("/upload", upload.single("file"), async (req, res) => {
    if (!req.file || !req.body.type) return res.status(400).json({ message: "Ð¤Ð°Ð¹Ð» Ð¸Ð»Ð¸ Ñ‚Ð¸Ð¿ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½" });

    try {
        const { type } = req.body; // logo Ð¸Ð»Ð¸ bgImage
        const settings = await DraftSettings.findOne();
        const oldFileUrl = settings?.[type];

        deleteOldFile(oldFileUrl);

        const fileUrl = `${req.protocol}://${req.get("host")}/uploads/${req.file.filename}`;
        console.log(`âœ… ${type} Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½:`, fileUrl);

        await DraftSettings.updateOne({}, { [type]: fileUrl }, { upsert: true });

        res.json({ url: fileUrl });
    } catch (error) {
        console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð°:", error);
        res.status(500).json({ message: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð°", error });
    }
});


// âœ… ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð² (Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾Ð´Ð¸Ð½ `settingsRoutes.js` Ð²Ð¼ÐµÑÑ‚Ð¾ 3 Ñ„Ð°Ð¹Ð»Ð¾Ð²)
const settingsRoutes = require("./routes/settingsRoutes");
app.use("/api", settingsRoutes);

const PORT = process.env.PORT || 5000;
app.listen(PORT, () => console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`));
